function max_click_reference(max_inx,h,handles)
reference = getappdata(gcf,'reference');
ButtonName = questdlg('Action?', ...
                      'Reference peak', ...
                      'Toggle mark', 'Remove peak','Toggle all','Toggle mark');

collection = getappdata(gcf,'collection');

switch ButtonName,
 case 'Toggle mark',
     [reference,collection] = toggle_mark(max_inx,reference,collection);
 case 'Toggle all',
     for max_inx = 1:length(reference.maxs)
         [reference,collection] = toggle_mark(max_inx,reference,collection);
     end
  case 'Remove peak',
     if reference.include_mask(max_inx) % Was previous included, toggle it off
         [reference,collection] = toggle_mark(max_inx,reference,collection);
     end
     reference.include_mask = [reference.include_mask(1:max_inx-1),reference.include_mask((max_inx+1):end)];
     max_id = reference.max_ids(max_inx);
     for s = 1:length(collection.match_inxs)
         inxs_to_change = find(collection.match_inxs{s} == max_id);
         collection.match_inxs{s}(inxs_to_change) = 0; % Match is no longer available
     end     
     reference.max_ids = [reference.max_ids(1:max_inx-1),reference.max_ids((max_inx+1):end)];
     reference.maxs = [reference.maxs(1:max_inx-1),reference.maxs((max_inx+1):end)];
     reference.mins = [reference.mins(1:max_inx-1,:);reference.mins((max_inx+1):end,:)];
end % switch

setappdata(gcf,'collection',collection);
refresh_axes2(handles);

setappdata(gcf,'reference',reference);
refresh_reference_peaks_listbox(handles);
refresh_axes1(handles);

function [reference,collection] = toggle_mark(max_inx,reference,collection)
inxs1 = find(reference.include_mask == 1);     
reference.include_mask(max_inx) = ~reference.include_mask(max_inx);
reference.max_ids(max_inx) = 0;
if ~reference.include_mask(max_inx) % If turning it off
    intersection = find(inxs1 == max_inx);
    if ~isfield(collection,'match_inxs')
        return;
    end
    for s = 1:length(collection.match_inxs)
        inxs_to_change = find(collection.match_inxs{s} == intersection);
        collection.match_inxs{s}(inxs_to_change) = 0; % Match is no longer available
    end
else % Turning it on
    inxs1 = find(reference.include_mask == 1); % Get updated
    intersection = find(inxs1 == max_inx);
    if ~isfield(collection,'match_inxs')
        return;
    end
end
