<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Results of targeted deconvolution test</title>

    <style type="text/css">
          <!--
table
{
border-collapse:collapse;
}
table,th, td
{
border: 1px solid black;
}
table.horizontal
{
border: none
}
table.horizontal th
{
border: none
}
td.perfect_peaks,th.perfect_peaks {background-color:green; }
td.detected_peaks,th.detected_peaks {background-color:red; }
td.hand_binned,th.hand_binned {background-color:blue; }
--> 
    </style>
  </head>
  <body dir="ltr" lang="en-US">
    
<h1> Results of first targeted deconvolution test </h1>

    
<h2> Abstract </h2>

    
<p> <em>Good news:</em>For isolated peaks with a good SNR (I used
      20:1), the software works fine (though error doubles if the peaks
      are very narrow (half-height width of 2 samples)). </p>

    
<p> <em>Bad news:</em>For peaks with low SNR or in a congested
      area, the errors are 20% and up. </p>

    
<p> <em>Good news:</em>It is likely that I can fix the majority of
      the problem for the low peaks and the moderately congested areas.
      My highly congested area may be so congested that there is really
      no hope for any algorithm. </p>

    
<h2> Methods </h2>

    
<p> I tested the targeted deconvolution by creating 20 spectra with
      7 bins each. The bins with a single peak had the peak at the
      center and a 100 sample width. Bins with multiple peaks were 200
      samples wide but only had peaks in the center 100 samples, giving
      50 samples for the signal to die out and not affect the other bins
      very much. 100 samples is the number of x values in 0.0430 ppm in
      the ANIT study. After generation of the signal, white
      pseudo-random zero-mean Gaussian noise with a standard deviation
      of 0.3 units was added. </p>

    
<p> In the congested regions, all peaks were purely Lorentzian and
      had a half-height width of 10 samples. The target peak had a SNR
      of about 40:1 and the other peaks had SNRs that ranged from 10-20.
    </p>

    
<h3> Peak Centers and SNRs for Most Congested Region (1000005) </h3>

    
<table class="horizontal">

      <tbody>
        <tr>
          <th>
            <p> Center </p>
          </th>
          <td>
            <p> 564 </p>
          </td>
          <td>
            <p> 577 </p>
          </td>
          <td>
            <p> 581 </p>
          </td>
          <td>
            <p> 587 </p>
          </td>
          <td>
            <p> 590 </p>
          </td>
          <td>
            <p> 597 </p>
          </td>
          <td>
            <p> 598 </p>
          </td>
          <td>
            <p> 599 </p>
          </td>
          <td>
            <p> 600 </p>
          </td>
          <td>
            <p> 605 </p>
          </td>
          <td>
            <p> 606 </p>
          </td>
          <td>
            <p> 608 </p>
          </td>
          <td>
            <p> 632 </p>
          </td>
        </tr>
        <tr>
          <th>
            <p> Base SNR </p>
          </th>
          <td>
            <p> 10 </p>
          </td>
          <td>
            <p> 12 </p>
          </td>
          <td>
            <p> 13 </p>
          </td>
          <td>
            <p> 13 </p>
          </td>
          <td>
            <p> 12 </p>
          </td>
          <td>
            <p> 13 </p>
          </td>
          <td>
            <p> 10 </p>
          </td>
          <td>
            <p> 13 </p>
          </td>
          <td>
            <p> 40 </p>
          </td>
          <td>
            <p> 14 </p>
          </td>
          <td>
            <p> 18 </p>
          </td>
          <td>
            <p> 20 </p>
          </td>
          <td>
            <p> 14 </p>
          </td>
        </tr>
      </tbody>
    
</table>

    
<p> The target peak is at 600. </p>

    
<h3> Peak Centers and SNR for Moderately Congested Region (1000006)
    </h3>

    
<table class="horizontal">

      <tbody>
        <tr>
          <th>
            <p> Center </p>
          </th>
          <td>
            <p> 777 </p>
          </td>
          <td>
            <p> 800 </p>
          </td>
          <td>
            <p> 813 </p>
          </td>
          <td>
            <p> 821 </p>
          </td>
          <td>
            <p> 823 </p>
          </td>
          <td>
            <p> 828 </p>
          </td>
        </tr>
        <tr>
          <th>
            <p> Base SNR </p>
          </th>
          <td>
            <p> 16 </p>
          </td>
          <td>
            <p> 40 </p>
          </td>
          <td>
            <p> 15 </p>
          </td>
          <td>
            <p> 20 </p>
          </td>
          <td>
            <p> 19 </p>
          </td>
          <td>
            <p> 10 </p>
          </td>
        </tr>
      </tbody>
    
</table>

    
<p> The target peak is at 800. </p>

    
<h3> Sample Generated Spectrum </h3>

    
<p> A picture of one generated spectrum follows: </p>

    
<p> <img src="results.figure.test-spectrum.png" name="test-spectrum"> </p>

    
<p> The target peaks are circled in red, the bin identifiers are
      written by the peaks in purple, and below the congested regions,
      the number of peaks in the region is written in green. </p>

    
<h2> Results </h2>

    
<h3> Isolated Peaks </h3>

    
<p> For the isolated peaks, the error in estimation was the same
      whether the peaks were detected or known a-priori. For the
      congested areas, there was a difference between perfectly known
      peak locations and detected locations, but it depended on the
      characteristics of the congested area. </p>

    
<p> Of the tall, isolated peaks, estimation was consistent with a
      slight bias towards underestimation. Error doubled when the peak
      was made very narrow. </p>

    
<p> The short isolated peaks had much higher errors than the tall
      peaks. Lorentzian-ness did not appreciably affect the absolute
      error. However, it did significantly change the bias. The
      half-Lorentzian peak had a bias on the order of 10% of the fully
      Lorentzian peak in both the perfect and detected peak conditions.
    </p>

    
<p> The narrow, short peaks had twice the error of any other
      isolated peak. They were highly biased toward overestimation. This
      bias was mitigated somewhat by detecting the peak location rather
      than using the true location. </p>

    
<h3> Congested Areas </h3>

    
<p> The congested areas performed much worse than the isolated
      peaks. However, with a-priori known peak locations, the moderately
      congested area (1000006) had livable error with a mean of 8.54%.
      When the locations were not known, that error went up to 30.26%. </p>

    
<p> The worst error was for the highly congested area. Individual
      estimates were more than double the actual in some cases. On
      average, even with perfect peaks, it returned an error of 51%,
      greatly underestimating the size of the peak most of the time. </p>

    
<h2> Discussion </h2>

    
<p> One easy to overlook factor in the measurement of the individual
      peaks with low SNR is that the small area magnifies the percentage
      error for the same absolute error. If a peak has an area of 20 and
      the estimate is off by 1, this is a 5% error. But if it has an
      area of 2 and the estimate is off by 1, this is a 50% error. A
      lower SNR intrinsically means that the estimation error will be
      larger. However, I would think that we can surely do better than
      20% for the wider small peaks. </p>

    
<p> To understand the poor performance, I looked carefully at the
      deconvolutions for ids 1000006 and 1000001 (bins 6 and 1
      respectively) in the detected peaks condition. Not knowing the
      what the errors were for each spectrum, I divided the spectra into
      two groups depending on whether the deconvolutions looked
      reasonable or not to my eye. For bin 1, I called the deconvolution
      reasonable if the baseline seemed to be in the right place and not
      too curved. For bin 6, I additionally called deconvolutions with
      peaks that were way too wide unreasonable. </p>

    
<p> For bin 1, I selected 8 spectra as having reasonable
      deconvolutions and 12 as unreasonable. For bin 6, only 6 spectra
      were reasonable and 14 were unreasonable. In bin 1, the reasonable
      spectra had a mean error of 9.8% whereas the unreasonable spectra
      had a mean error of 31%. In bin 6, the difference was even more
      pronounced. The reasonable spectra had a mean error of 6% versus
      41% for the unreasonable spectra. </p>

    
<h3> Examples from Bin 1 </h3>

    
<p> The estimated baseline is in yellow, the estimated peaks are in
      magenta. The fitted curve (the baseline + sum of peaks) is in
      gray. The original spectrum is in blue. </p>

    
<h4> Reasonable </h4>

    
<p> <img alt="Reasonable deconvolution of a spectrum in bin 1" src="results.figure.bin-1-reasonable-deconvolution.png" width="876" height="379"> </p>

    
<h4> Unreasonable </h4>

    
<p> <img alt="Unreasonable deconvolution of the spectrum in bin 1
        due to bad baseline" src="results.figure.bin-1-unreasonable-deconvolution.png" width="872" height="379"> </p>

    
<h3> Examples from Bin 6 </h3>

    
<h4> Reasonable </h4>

    
<p> <img alt="Reasonable deconvolution of the spectrum in bin 6" src="results.figure.reasonable-deconvolution.png" width="889" height="382"> </p>

    
<h4> Unreasonable because of baseline </h4>

    
<p> <img alt="A deconvolution of a spectrum in bin 6 that is
        unreasonable because of its highly curved baseline" src="results.figure.unreasonable-deconvolution-baseline.png" width="885" height="381"> </p>

    
<h4> Unreasonable because of broad peak </h4>

    
<p> <img alt="A deconvolution of a spectrum in bin 6 that is
        unreasonable because of its positing of a broad peak that is not
        seen in the peaks above" src="results.figure.unreasonable-deconvolution-broad-peak.png" width="889" height="380"> </p>

    
<h3> Bad Baseline </h3>

    
<p> The two bins I examined in detail shared the common problem of
      bad baseline estimation. In bin 1, this was the only factor I used
      in selecting my unreasonable deconvolutions. In bin 6, 9 of the 14
      spectra I selected were selected because of bad baseline
      estimation. </p>

    
<p> I believe I can fix much of the problem by allowing the user to
      add simple constraints on the baseline. If the baseline is
      constrained to be a constant or a straight line then it can't
      curve up very much to take area away from actual peaks. By making
      this a user-settable parameter, I can give the user the ability to
      allow the baseline to curve when he feels that it needs to. This
      estimation is likely to work because my eyeball selection of peaks
      with good baselines was able to substantially reduce the error on
      this test set. </p>

    
<h3> Big Peaks </h3>

    
<p> The big peaks are another problem. They are much less common
      when there is a perfect information on the location of peaks. (14
      under detected peaks and 5 under perfect peaks). This is partially
      caused by the reduction in bad baseline fits under perfect peak
      locations (9 under detected and 3 under perfect). Since the bad
      baseline is highly correlated with having a broad peak in bin 6,
      one would expect the decrease. </p>

    
<p> However, there are several cases in both the perfect condition
      (2, 5, 14) and in the detected condition (1, 8, 9, 12, 15) where
      there is a broad peak but the baseline is reasonable. </p>

    
<p> The cause of this phenomenon is not obvious. It appears that
      they are a bad and broad local minimum in the search space for
      correct peak widths. Maybe introducing a bit of randomization in
      the initial conditions could provide a way out. </p>

    
<p> This will take some experimentation to solve. </p>

    
<h3> Limited Resolution </h3>

    
<p> <img alt="Deconvolution of bin 5" src="results.figure.bin-5-deconvolution.png" width="883" height="382"> </p>

    
<p> The worst errors in the test came from bin 5 (spectrum 12
      pictured above - the error is 66%). I believe a lot of the
      problems stem from the fact that there are peaks at 597, 598, 599,
      and 600. Those peaks are located at adjacent samples, so it is
      hard for any technique to resolve them. Even though their sum is
      different than it would be if they were of different heights and
      widths the noise makes distinguishing such small variations very
      challenging. To deconvolve those peaks would take a lot more
      a-priori information than we have available right now. In certain
      circumstances with a number of different spectra it might be
      possible to use the information encoded in the peak-shifts to
      locate which peak is where in each spectrum. However, at the
      moment, resolving these peaks is, at best, a difficult research
      topic at best; it may be impossible. </p>

    
<p> The reason this spectrum has so many close peaks is that I got
      my initial peak locations from random.org - which generates true
      random numbers. I then moved peaks away from the target peak to
      make it visible. However, I was looking at the list of numbers in
      unsorted order and I overlooked 597, 598, and 599 as being close
      to 600 since they didn't start with 6. I left this in there
      because I was almost done with the final test when I figured out
      what had happened and I didn't want to spend another 4 hours
      re-doing the 140 deconvolutions. </p>

    
<h2> Future Work </h2>

    
<p> My next step will be to modify the architecture of the targeted
      deconvolution to allow different models with different types of
      constraints. Then I will implement baseline constraints and retest
      the code with them. </p>

    
<p> From there, I am not sure where I will go. I may look at the
      areas of the spectrum that Isaie is interested in and try to
      simulate them with artificial spectra and look at the performance
      of the code on those spectra. This would give us more confidence
      in the results if the performance is acceptable, or a target to
      shoot for if it is not. </p>

    
<p> I may also implement a few more constraints - treating peaks
      under the influence of j-coupling differently will speed up the
      estimation and also improve its quality. </p>

    
<h1> Raw Results Summary </h1>

    
<table>

      <thead>
        <tr>
          <th> Quantization Method </th>
          <th> Mean pct </th>
          <th> Std dev </th>
          <th> Mean % difference </th>
          <th> Std dev % difference </th>
          <th> Lorentzian-ness </th>
          <th> Half Height Width (samples) </th>
          <th> SNR of Target <br>
            (x±1:1) </th>
          <th> Number of Peaks </th>
          <th> ID </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 5.14 </td>
          <td> 6.11 </td>
          <td> -3.64 </td>
          <td> 7.15 </td>
          <td> 1 </td>
          <td> 20 </td>
          <td> 20 </td>
          <td> 1 </td>
          <td> 1000000 </td>
        </tr>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 22.32 </td>
          <td> 15.24 </td>
          <td> -18.88 </td>
          <td> 19.53 </td>
          <td> 1 </td>
          <td> 20 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000001 </td>
        </tr>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 21.45 </td>
          <td> 15.05 </td>
          <td> 1.41 </td>
          <td> 26.62 </td>
          <td> 0.5 </td>
          <td> 20 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000002 </td>
        </tr>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 9.71 </td>
          <td> 7.48 </td>
          <td> -1.65 </td>
          <td> 12.34 </td>
          <td> 1 </td>
          <td> 2 </td>
          <td> 20 </td>
          <td> 1 </td>
          <td> 1000003 </td>
        </tr>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 45.19 </td>
          <td> 41.91 </td>
          <td> 19.90 </td>
          <td> 59.07 </td>
          <td> 1 </td>
          <td> 2 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000004 </td>
        </tr>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 51.32 </td>
          <td> 21.94 </td>
          <td> -49.46 </td>
          <td> 26.05 </td>
          <td> 1 </td>
          <td> 10 </td>
          <td> 40 </td>
          <td> 13 </td>
          <td> 1000005 </td>
        </tr>
        <tr>
          <td class="perfect_peaks"> Perfect Peaks </td>
          <td> 8.54 </td>
          <td> 12.54 </td>
          <td> -7.07 </td>
          <td> 13.47 </td>
          <td> 1 </td>
          <td> 10 </td>
          <td> 40 </td>
          <td> 6 </td>
          <td> 1000006 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 5.11 </td>
          <td> 6.09 </td>
          <td> -3.67 </td>
          <td> 7.10 </td>
          <td> 1 </td>
          <td> 20 </td>
          <td> 20 </td>
          <td> 1 </td>
          <td> 1000000 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 22.24 </td>
          <td> 15.28 </td>
          <td> -18.80 </td>
          <td> 19.55 </td>
          <td> 1 </td>
          <td> 20 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000001 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 20.59 </td>
          <td> 15.18 </td>
          <td> 1.88 </td>
          <td> 25.94 </td>
          <td> 0.5 </td>
          <td> 20 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000002 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 9.71 </td>
          <td> 7.48 </td>
          <td> -1.65 </td>
          <td> 12.34 </td>
          <td> 1 </td>
          <td> 2 </td>
          <td> 20 </td>
          <td> 1 </td>
          <td> 1000003 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 44.36 </td>
          <td> 39.18 </td>
          <td> 8.19 </td>
          <td> 59.46 </td>
          <td> 1 </td>
          <td> 2 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000004 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 31.04 </td>
          <td> 38.69 </td>
          <td> 25.57 </td>
          <td> 42.70 </td>
          <td> 1 </td>
          <td> 10 </td>
          <td> 40 </td>
          <td> 13 </td>
          <td> 1000005 </td>
        </tr>
        <tr>
          <td class="detected_peaks"> Detected Peaks </td>
          <td> 30.26 </td>
          <td> 18.84 </td>
          <td> -29.99 </td>
          <td> 19.28 </td>
          <td> 1 </td>
          <td> 10 </td>
          <td> 40 </td>
          <td> 6 </td>
          <td> 1000006 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 10.48 </td>
          <td> 2.92 </td>
          <td> -10.48 </td>
          <td> 2.92 </td>
          <td> 1 </td>
          <td> 20 </td>
          <td> 20 </td>
          <td> 1 </td>
          <td> 1000000 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 23.47 </td>
          <td> 5.11 </td>
          <td> -23.47 </td>
          <td> 5.11 </td>
          <td> 1 </td>
          <td> 20 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000001 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 11.69 </td>
          <td> 6.80 </td>
          <td> -11.26 </td>
          <td> 7.53 </td>
          <td> 0.5 </td>
          <td> 20 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000002 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 7.74 </td>
          <td> 7.07 </td>
          <td> 1.76 </td>
          <td> 10.48 </td>
          <td> 1 </td>
          <td> 2 </td>
          <td> 20 </td>
          <td> 1 </td>
          <td> 1000003 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 19.02 </td>
          <td> 15.86 </td>
          <td> -7.07 </td>
          <td> 24.07 </td>
          <td> 1 </td>
          <td> 2 </td>
          <td> 6 </td>
          <td> 1 </td>
          <td> 1000004 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 54.47 </td>
          <td> 2.02 </td>
          <td> 54.47 </td>
          <td> 2.02 </td>
          <td> 1 </td>
          <td> 10 </td>
          <td> 40 </td>
          <td> 13 </td>
          <td> 1000005 </td>
        </tr>
        <tr>
          <td class="hand_binned"> Hand Binned </td>
          <td> 7.16 </td>
          <td> 1.33 </td>
          <td> -7.16 </td>
          <td> 1.33 </td>
          <td> 1 </td>
          <td> 10 </td>
          <td> 40 </td>
          <td> 6 </td>
          <td> 1000006 </td>
        </tr>
      </tbody>
    
</table>

    
<h2> Comparison of Quantization Method Errors </h2>

    
<table>

      <thead>
        <tr>
          <th class="perfect_peaks">Perfect Peaks<br>
          </th>
          <th class="detected_peaks">Detected Peaks </th>
          <th class="hand_binned"> Hand-binned </th>
          <th> ID </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td> 5.14 </td>
          <td> 5.11 </td>
          <td> 10.48 </td>
          <td> 1000000 </td>
        </tr>
        <tr>
          <td> 22.32 </td>
          <td> 22.24 </td>
          <td> 23.47 </td>
          <td> 1000001 </td>
        </tr>
        <tr>
          <td> 21.45 </td>
          <td> 20.59 </td>
          <td> 11.69 </td>
          <td> 1000002 </td>
        </tr>
        <tr>
          <td> 9.71 </td>
          <td> 9.71 </td>
          <td> 7.74 </td>
          <td> 1000003 </td>
        </tr>
        <tr>
          <td> 45.19 </td>
          <td> 44.36 </td>
          <td> 19.02 </td>
          <td> 1000004 </td>
        </tr>
        <tr>
          <td> 51.32 </td>
          <td> 31.04 </td>
          <td> 54.47 </td>
          <td> 1000005 </td>
        </tr>
        <tr>
          <td> 8.54 </td>
          <td> 30.26 </td>
          <td> 7.16 </td>
          <td> 1000006 </td>
        </tr>
      </tbody>
    
</table>

    
<p> <br>
      <br>
    </p>

    
<p> <br>
      <br>
    </p>

  

</body></html>